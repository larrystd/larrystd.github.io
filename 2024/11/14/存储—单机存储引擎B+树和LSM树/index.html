<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>存储——单机存储引擎B+树和LSM树 | Infinity Code</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">存储——单机存储引擎B+树和LSM树</h1><a id="logo" href="/.">Infinity Code</a><p class="description">Simplicity is the soul of efficiency.</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">存储——单机存储引擎B+树和LSM树</h1><div class="post-meta">2024-11-14<span> | </span><span class="category"><a href="/categories/storage/">storage</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#B%E6%A0%91%E5%92%8CB-%E6%A0%91"><span class="toc-number">1.</span> <span class="toc-text">B树和B+树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LSM%E6%A0%91"><span class="toc-number">2.</span> <span class="toc-text">LSM树</span></a></li></ol></div></div><div class="post-content"><p>B+树和LSM树是最常见的单机存储引擎，前者代表是Mysql等事务性数据库，后者代表是Rocksdb等nosql KV数据库。</p>
<span id="more"></span>

<h3 id="B树和B-树"><a href="#B树和B-树" class="headerlink" title="B树和B+树"></a>B树和B+树</h3><p>B树是一种平衡的多叉树，通常说m 阶B树，树的阶指的是B树中节点的子节点数目的最大值。</p>
<p>B树必须满足如下条件：</p>
<ol>
<li>所有叶子节点都在同一层级；</li>
<li>除了根节点以外的<strong>其他节点包含的key值数量</strong>在<code>[m/2]-1</code>到<code>m-1</code>的数据范围；</li>
<li>除了根节点和叶子节点外，<strong>所有中间节点至少有m&#x2F;2个子节点</strong>；</li>
<li>根节点如果不是叶子节点的话，它必须包含至少2个孩子节点；</li>
<li><strong>拥有n-1个key值非叶子节点必须有n个孩子节点</strong>；这要求每个key的前后都有指向子节点的指针</li>
<li>一个节点的所有key值必须是升序排序的；</li>
</ol>
<p><img src="/../images/Btree.png" alt="Btree" title="Btree"></p>
<p>B+树是应文件系统所需而产生的 B 树的变形树。B+树的特征：</p>
<ol>
<li>B+树包含2种类型的节点：内部节点（也称索引节点）和叶子节点。根节点本身即可以是内部节点，也可以是叶子节点。</li>
<li>B+树与B树最大的不同是<strong>内部节点不保存数据，只用于索引，所有数据（或者说记录）都保存在叶子节点中；</strong></li>
<li>m阶B+树表示了内部节点最多有m-1个key（或者说内部节点最多有m个子树，和B树相同），<strong>阶数m同时限制了叶子节点最多存储m-1个记录</strong>；</li>
<li>内部节点中的key都按照从小到大的顺序排列，对于内部节点中的一个key，左树中的所有key都小于它，右子树中的key都大于等于它。叶子节点中的记录也按照key的大小排列；<br><strong>每个叶子节点都存有相邻叶子节点的指针</strong>，叶子节点本身依key的大小自小而大顺序链接；</li>
</ol>
<p><img src="/../images/B+tree.png" alt="B+tree" title="B+tree"></p>
<p>B+ 树相比 B 树，最大差异是<strong>非叶子节点不再存储具体数据，以及叶子节点是链表结构</strong>。非叶子节点不再存储具体数据，这使得 <strong>B+ 树更加扁平化</strong>，查找效率更高。叶子节点是链表结构，这使得 <strong>B+ 树更适合用在范围查找</strong>的场景中。</p>
<p>在Mysql的InnoDB中，每个数据表的索引都会有一个B+树维护。在主键索引中，B+树的节点是16K固定大小的page，page内部由记录链表构成，每个记录的key是主键，value则是行数据。B+树查询相当于一个巨大的二分查找，先根据主键和区间定位到主键所属的page，然后在page内部遍历记录链表找到key所在的记录和行数据。</p>
<p>B+树的优势</p>
<ol>
<li>B+树的非叶子节点不存储数据，内存可以容纳，实际磁盘IO数量只有访问叶子节点的一次。</li>
<li>B+树叶子节点有序，互相有链接，范围查询能充分利用磁盘的顺序读优势</li>
<li>B+树的节点是固定大小的page，page对齐落盘。但如果数据页没有在cache，写操作需要等待数据页从磁盘中读取，写性能不如读</li>
</ol>
<h3 id="LSM树"><a href="#LSM树" class="headerlink" title="LSM树"></a>LSM树</h3><p>LSM（Log-Structured Merge Tree）相比B+树，写性能高，读性能稍逊。</p>
<p>LSM 树由两部分组成：</p>
<ol>
<li>MemTable（内存表）</li>
</ol>
<p>是一个可变的有序数据结构（如红黑树或跳表），存储数据的最新写入。使用redolog保证memtable的数据安全，写操作先顺序写redolog和MemTable，提高写性能。</p>
<ol start="2">
<li>SSTable（Sorted String Table）</li>
</ol>
<p>当 MemTable 达到一定大小时，会作为SSTable文件写入磁盘。SSTable 是不可变的。<br>SSTable 通常通过多个层级组织，使用compaction策略减少存储。</p>
<p>LSM的特点</p>
<ol>
<li>写性能高</li>
<li>读性能不稳定，随着需要读的数据位置层次由高到低，读性能逐渐下降。读操作存在大量不必要的磁盘读操作，可用布隆过滤器缓解</li>
<li>写放大，写操作先写redolog和memtable，memtable后台dump到sst, 旧sst再重新comapction到新的sst，后台存在大量读写。大量写放大可能增加磁盘IO压力影响前台IO，磁盘寿命。</li>
<li>空间放大。更新键和删除键同样写入到redolog和memtable，不同层级的SSTable可能存在相同但新旧不同的键。</li>
<li></li>
</ol>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/storage/" rel="tag">storage</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/11/15/%E5%AD%98%E5%82%A8%E2%80%94%E5%9D%97%E3%80%81%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8/">存储——块、对象和文件存储</a><a class="next" href="/2024/11/10/linux%E7%B3%BB%E7%BB%9F(2)%E2%80%94%E5%86%85%E5%AD%98%E5%92%8CIO%E7%BD%91%E7%BB%9C/">linux系统(2)——内存和IO网络</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://larrystd.github.io"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.png"/></a><p>To be a better man.</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:admin@domain.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/application/">application</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/compute/">compute</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hello/">hello</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/language/">language</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/storage/">storage</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/hello/" style="font-size: 15px;">hello</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/brpc/" style="font-size: 15px;">brpc</a> <a href="/tags/storage/" style="font-size: 15px;">storage</a> <a href="/tags/leveldb/" style="font-size: 15px;">leveldb</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/application/" style="font-size: 15px;">application</a> <a href="/tags/base/" style="font-size: 15px;">base</a> <a href="/tags/language/" style="font-size: 15px;">language</a> <a href="/tags/cpp/" style="font-size: 15px;">cpp</a> <a href="/tags/coroutine/" style="font-size: 15px;">coroutine</a> <a href="/tags/compute/" style="font-size: 15px;">compute</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/07/06/brpc(1)%E2%80%94bthread%E5%92%8Cbrpc/">brpc(1)—bthread和brpc</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/05/03/%E8%AE%A1%E7%AE%97(2)%E2%80%94GPU%E8%AE%A1%E7%AE%97%E5%92%8C%E5%A4%A7%E6%A8%A1%E5%9E%8B/">计算(2)——GPU计算和大模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/27/%E8%AE%A1%E7%AE%97(1)%E2%80%94CPU%E8%AE%A1%E7%AE%97%E5%92%8C%E5%A4%A7%E6%95%B0%E6%8D%AE/">计算(1)——CPU计算和大数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/22/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E2%80%94C++%E5%8F%B3%E5%80%BC%E5%92%8C%E5%8F%B3%E5%80%BC%E5%BC%95%E7%94%A8/">编程语言——C++右值和右值引用</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/20/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E2%80%94C++%E5%8D%8F%E7%A8%8B%E5%92%8C%E9%AB%98%E6%80%A7%E8%83%BD%E7%BC%96%E7%A8%8B/">编程语言——C++协程和高性能编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/04/07/%E5%AD%98%E5%82%A8%E2%80%94%E8%B0%88%E5%AD%98%E5%82%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">存储——谈存储文件系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/15/leveldb(2)%E2%80%94%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/">leveldb(2)—线程模型和并发控制</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/12/redis(2)%E2%80%94%E7%BD%91%E7%BB%9C%E5%A4%84%E7%90%86%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96/">redis(2)——网络处理和持久化</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/10/redis(1)%E2%80%94%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">redis(1)——数据结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/01/31/leveldb(1)%E2%80%94%E6%A6%82%E8%A7%88/">leveldb(1)—概览</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2026 <a href="/." rel="nofollow">Infinity Code.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>